rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if user owns this document
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // ============================================
    // USER COLLECTION & SUBCOLLECTIONS
    // ============================================
    match /users/{userId} {
      // Allow any authenticated user to read user profiles 
      // (Required for showing "Reported By", "Assigned To" names etc)
      allow read: if isAuthenticated();
      
      // Only the user themselves can write their own profile
      allow write: if isOwner(userId);
      
      // PREPAREDNESS PLAN (Subcollection)
      // Moved to top-level match to avoid any variable scoping ambiguity
      // match /preparedness_plan/{itemId} {
      //   allow read, write: if isAuthenticated() && request.auth.uid == userId;
      // }
    }
    

    
    // ============================================
    // PUBLIC / SHARED COLLECTIONS
    // ============================================
    
    // Emergency Alerts - Read by all, Admin write
    match /emergency_alerts/{alertId} {
      allow read: if isAuthenticated();
      // Allow updating 'isRead' status? No, isRead is usually local or subcollection.
      // But if app logic updates the alert doc directly, we need update permission.
      allow update: if isAuthenticated(); 
      allow create, delete: if false; // Admin only
    }
    
    // Tasks - Read by all (or volunteers), Update status
    match /tasks/{taskId} {
      allow read: if isAuthenticated();
      allow update: if isAuthenticated();
      allow create, delete: if false; // Admin only
    }
    
    // Incidents - Read by all, Create/Update by all
    match /incidents/{incidentId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if false;
    }
    
    // Person Statuses (Safe/Missing) - Read/Write by all
    match /person_statuses/{personStatusId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if false;
    }
    
    // Preparedness Templates - Read by all authenticated
    match /preparedness_templates/{templateId} {
      allow read: if isAuthenticated();
      allow write: if false; // Admin only
    }
    
    // Shelters - Read only
    match /shelters/{shelterId} {
      allow read: if isAuthenticated();
      allow write: if false; // Admin only
    }
    
    // Notifications - Individual Access
    match /notifications/{notificationId} {
       // If notifications have userId field, check it. 
       // For now, allow auth users to manage notifications
       allow read, write: if isAuthenticated();
    }
    
    // FCM Tokens
    match /fcm_tokens/{tokenId} {
      allow read, write: if isAuthenticated();
    }
    
    // Catch-all deny
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
